#!/usr/bin/env bash 

set -euo pipefail

layer_dir=$1

echo "---> build env: ${@}"

env
id

echo "---> installing caddy"
caddy_version=2.4.0
caddy_layer_dir=${layer_dir}/caddy
mkdir -p ${caddy_layer_dir}/{bin,etc}
caddy_release=https://github.com/caddyserver/caddy/releases/download/v${caddy_version}/caddy_${caddy_version}_linux_amd64.tar.gz
curl -sLo- ${caddy_release} | tar -C ${caddy_layer_dir}/bin -zxv caddy

cat > "${caddy_layer_dir}.toml" << EOF
launch = true
build = true
cache = false

[metadata]
version = "${caddy_version}"
url = "${caddy_release}"
EOF

echo "---> launch config"
# Make caddy available
export PATH=${caddy_layer_dir}/bin:$PATH

cat > "$layer_dir/launch.toml" <<EOL
[[processes]]
type = "web"
command = "caddy file-server --browse --listen :8080"
EOL

echo "---> done"
