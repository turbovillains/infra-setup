---
variables:
  DOCKER_NAMESPACE: infra
  DEPLOYER_BASE: ubuntu:focal
  BUILDER_BASE: debian:10.4-slim
  FREERADIUS_VERSION: 3.0.21-alpine
  TRAEFIK_VERSION: v2.2.1
  MKDOCS_VERSION: 5.3.3

stages:
  - import-images
  - build

import-images:
  stage: import-images
  script:
    - ./gitlab/${CI_JOB_STAGE}.sh

deployer:
  stage: build
  script:
    - ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg DEPLOYER_BASE

builder:
  stage: build
  script:
    - ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg BUILDER_BASE

radius:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg FREERADIUS_VERSION

mkdocs:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MKDOCS_VERSION

traefik:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg TRAEFIK_VERSION
