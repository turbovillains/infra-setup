---
variables:
  DOCKER_NAMESPACE: infra
  DEPLOYER_BASE: ubuntu:focal-20201106
  BUILDER_BASE: debian:10.7-slim
  FREERADIUS_VERSION: 3.0.21-alpine
  TRAEFIK_VERSION: "v2.4.0"
  MKDOCS_VERSION: "6.2.5"
  JEKYLL_VERSION: "4.2.0"
  POWERDNS_BASE: debian:10.7-slim
  POWERDNS_VERSION: "4.3.0"
  GATSBY_BUILD_BASE: node:14-buster
  GATSBY_VERSION: "2.12.99"
  GATSBY_BASE: alpine:edge
  LATEX_BASE: ubuntu:focal-20201106
  KEYCLOAK_VERSION: "12.0.2"
  POSTGRES_VERSION: "13.1"
  JIRA_VERSION: "8.13.0"
  MAILSERVER_VERSION: "release-v7.1.0"
  NEXTCLOUD_VERSION: "20.0.5-apache"
  SPEEDTEST_VERSION: v1.1.2
  HAPROXY_VERSION: 2.3.4
  MINIO_VERSION: RELEASE.2021-02-07T01-31-02Z

stages:
  - import-images
  - build

import-images:
  stage: import-images
  script:
    - ./gitlab/${CI_JOB_STAGE}.sh

deployer:
  stage: build
  script:
    - ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg DEPLOYER_BASE

builder:
  stage: build
  script:
    - ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg BUILDER_BASE --build-arg GIT_SERVER_HOST=${CI_SERVER_HOST} --build-arg SSH_PRIVATE_KEY

radius:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg FREERADIUS_VERSION

mkdocs:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MKDOCS_VERSION

traefik:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg TRAEFIK_VERSION

jekyll:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg JEKYLL_VERSION

gatsby-build:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg GATSBY_BUILD_BASE --build-arg GATSBY_VERSION

gatsby:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg GATSBY_BASE

latex:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg LATEX_BASE

powerdns:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg POWERDNS_BASE

keycloak:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KEYCLOAK_VERSION

postgres:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg POSTGRES_VERSION

jira:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg JIRA_VERSION

mailserver:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MAILSERVER_VERSION

nextcloud:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg NEXTCLOUD_VERSION

speedtest:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg SPEEDTEST_VERSION

haproxy:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg HAPROXY_VERSION

minio:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MINIO_VERSION
