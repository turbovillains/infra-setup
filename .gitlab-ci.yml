---
variables:
  DOCKER_NAMESPACE: infra
  DEPLOYER_BASE: ubuntu:focal-20210217 # https://hub.docker.com/_/ubuntu?tab=tags&page=1&ordering=last_updated&name=focal
  BUILDER_BASE: debian:10.8-slim  # https://hub.docker.com/_/debian?tab=tags&page=1&ordering=last_updated&name=10.8
  DEBIAN_VERSION: 10.8-slim
  FREERADIUS_VERSION: 3.0.21-alpine # https://hub.docker.com/r/freeradius/freeradius-server/tags?page=1&ordering=last_updated&name=3.0.21
  TRAEFIK_VERSION: "v2.4.6" # https://hub.docker.com/_/traefik?tab=tags&page=1&ordering=last_updated&name=2.4
  MKDOCS_VERSION: "7.0.4" # https://hub.docker.com/_/traefik?tab=tags&page=1&ordering=last_updated&name=2.4
  JEKYLL_VERSION: "4.2.0" # https://hub.docker.com/r/jekyll/jekyll/tags?page=1&ordering=last_updated
  POWERDNS_BASE: debian:10.8-slim # https://hub.docker.com/_/debian?tab=tags&page=1&ordering=last_updated&name=10.8
  POWERDNS_VERSION: "4.4.1" # https://www.powerdns.com/downloads.html
  GATSBY_BUILD_BASE: node:15-buster # https://hub.docker.com/_/node?tab=description&page=1&ordering=last_updated
  GATSBY_VERSION: "2.12.99" # https://www.npmjs.com/package/gatsby
  GATSBY_BASE: alpine:3.12.4 # https://hub.docker.com/_/alpine?tab=tags&page=1&ordering=last_updated&name=3.12.4
  LATEX_BASE: ubuntu:focal-20210217 # https://hub.docker.com/_/ubuntu?tab=tags&page=1&ordering=last_updated&name=focal
  KEYCLOAK_VERSION: "12.0.4" # https://hub.docker.com/r/jboss/keycloak/tags?page=1&ordering=last_updated&name=12.0
  POSTGRES_VERSION: "13.2" # https://hub.docker.com/_/postgres
  JIRA_VERSION: "8.15.0" # https://hub.docker.com/r/atlassian/jira-software/tags?page=1&ordering=last_updated&name=8.15
  MAILSERVER_VERSION: "release-v7.1.0"
  NEXTCLOUD_VERSION: "20.0.8-apache" # https://hub.docker.com/_/nextcloud
  SPEEDTEST_VERSION: v1.1.2
  HAPROXY_VERSION: "2.3.6" # https://hub.docker.com/_/haproxy?tab=tags&page=1&ordering=last_updated
  MINIO_VERSION: RELEASE.2021-03-04T00-53-13Z # https://hub.docker.com/r/minio/minio/tags?page=1&ordering=last_updated
  ETCD_VERSION: v3.4.15
  PROMETHEUS_VERSION: v2.25.0
  ALERTMANAGER_VERSION: v0.21.0
  NODE_EXPORTER_VERSION: v1.1.2
  CONSUL_EXPORTER_VERSION: v0.7.1
  BLACKBOX_EXPORTER_VERSION: v0.18.0
  SNMP_EXPORTER_VERSION: v0.20.0
  IPMI_EXPORTER_VERSION: v1.3.2
  GRAFANA_VERSION: "7.4.3" # https://hub.docker.com/r/grafana/grafana/tags?page=1&ordering=last_updated&name=7.4
  M3DBNODE_VERSION: v1.0.0 # https://quay.io/repository/m3db/m3dbnode?tag=latest&tab=tags
  M3COORDINATOR_VERSION: v1.0.0
  PROMETHEUS_ES_EXPORTER_VERSION: "0.14.0"
  SSL_EXPORTER_VERSION: v2.2.0
  CADVISOR_VERSION: v0.37.5
  KARMA_VERSION: v0.80
  PUSHGATEWAY_VERSION: v1.4.0
  LDAP_EXPORTER_VERSION: 0.0.3-2-dev
  LOGSTASH_VERSION: "7.11.1"
  KIBANA_VERSION: "7.11.1"
  CORTEX_VERSION: v1.7.0
  ALERTA_VERSION: "8.4.1"
  MONGO_VERSION: 4.4.4-bionic
  WORDPRESS_VERSION: 5.7.0-apache   # https://hub.docker.com/_/wordpress?tab=description&page=1&ordering=last_updated
  PGADMIN_VERSION: "5.0"   # https://hub.docker.com/r/dpage/pgadmin4/tags?page=1&ordering=last_updated
  MYSQL_VERSION: "8.0.23" # https://registry.hub.docker.com/_/mysql/
  MARIADB_VERSION: 10.5.9-focal # https://hub.docker.com/_/mariadb
  HTTPBIN_VERSION: a9f17f0 # https://hub.docker.com/r/mccutchen/go-httpbin/tags?page=1&ordering=last_updated
  KAFKA_ZOOKEEPER_VERSION: 6.1.1
  KAFKA_SERVER_VERSION: 6.1.1
  KAFKA_SCHEMA_REGISTRY_VERSION: 6.1.1
  KAFKA_SERVER_CONNECT_DATAGEN_VERSION: 0.4.0-6.1.0
  KAFKA_ENTERPRISE_CONTROL_CENTER_VERSION: 6.1.1
  KAFKA_KSQLDB_SERVER_VERSION: 6.1.1
  KAFKA_KSQLDB_CLI_VERSION: 6.1.1
  KAFKA_REST_VERSION: 6.1.1
  KAFKA_KSQLDB_EXAMPLES_VERSION: 6.1.1

stages:
  - import-images
  - build
  - build-monitoring
  - build-kafka
  - build-builder
  - build-deployer
  - build-latex

import-images:
  stage: import-images
  script:
    - ./gitlab/${CI_JOB_STAGE}.sh

deployer:
  stage: build-deployer
  script:
    - ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg DEPLOYER_BASE

builder:
  stage: build-builder
  script:
    - ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg BUILDER_BASE --build-arg GIT_SERVER_HOST=${CI_SERVER_HOST} --build-arg SSH_PRIVATE_KEY \
        --build-arg HOST_DOCKER_GID=$(stat -t /var/run/docker.sock | awk '{ print $6 }')

radius:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg FREERADIUS_VERSION

mkdocs:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MKDOCS_VERSION

traefik:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg TRAEFIK_VERSION

jekyll:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg JEKYLL_VERSION

gatsby-build:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg GATSBY_BUILD_BASE --build-arg GATSBY_VERSION

gatsby:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg GATSBY_BASE

latex:
  stage: build-latex
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg LATEX_BASE

powerdns:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg POWERDNS_BASE

keycloak:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KEYCLOAK_VERSION

postgres:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg POSTGRES_VERSION

jira:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg JIRA_VERSION

mailserver:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MAILSERVER_VERSION

nextcloud:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg NEXTCLOUD_VERSION

speedtest:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg SPEEDTEST_VERSION

haproxy:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg HAPROXY_VERSION

minio:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MINIO_VERSION

prometheus:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg PROMETHEUS_VERSION

karma:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KARMA_VERSION

alertmanager:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg ALERTMANAGER_VERSION

pushgateway:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg PUSHGATEWAY_VERSION

blackbox-exporter:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg BLACKBOX_EXPORTER_VERSION

snmp-exporter:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg SNMP_EXPORTER_VERSION

ipmi-exporter:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg IPMI_EXPORTER_VERSION --build-arg DEBIAN_VERSION

cadvisor:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg CADVISOR_VERSION

node-exporter:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg NODE_EXPORTER_VERSION

consul-exporter:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg CONSUL_EXPORTER_VERSION

prometheus-es-exporter:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg PROMETHEUS_ES_EXPORTER_VERSION

ssl-exporter:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg SSL_EXPORTER_VERSION

rsyslog:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg DEBIAN_VERSION

ioping-exporter:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}

ldap-exporter:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg LDAP_EXPORTER_VERSION

grafana:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg GRAFANA_VERSION \
        --build-arg HTTP_PROXY \
        --build-arg NO_PROXY

m3dbnode:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg M3DBNODE_VERSION

m3coordinator:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg M3COORDINATOR_VERSION

cortex:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg CORTEX_VERSION

logstash:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg LOGSTASH_VERSION

kibana:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KIBANA_VERSION
mongo:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MONGO_VERSION

alerta:
  stage: build-monitoring
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg ALERTA_VERSION

wordpress:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg WORDPRESS_VERSION

pgadmin:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg PGADMIN_VERSION

mysql:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MYSQL_VERSION

mariadb:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg MARIADB_VERSION

httpbin:
  stage: build
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg HTTPBIN_VERSION

cp-zookeeper:
  stage: build-kafka
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KAFKA_ZOOKEEPER_VERSION

cp-server:
  stage: build-kafka
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KAFKA_SERVER_VERSION

cp-schema-registry:
  stage: build-kafka
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KAFKA_SCHEMA_REGISTRY_VERSION

cp-server-connect-datagen:
  stage: build-kafka
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KAFKA_SERVER_CONNECT_DATAGEN_VERSION

cp-enterprise-control-center:
  stage: build-kafka
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KAFKA_ENTERPRISE_CONTROL_CENTER_VERSION

cp-ksqldb-server:
  stage: build-kafka
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KAFKA_KSQLDB_SERVER_VERSION

cp-ksqldb-cli:
  stage: build-kafka
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KAFKA_KSQLDB_CLI_VERSION

cp-ksqldb-examples:
  stage: build-kafka
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KAFKA_KSQLDB_EXAMPLES_VERSION

cp-kafka-rest:
  stage: build-kafka
  script:
    - |
      ./gitlab/build-image.sh ${CI_JOB_NAME} ${DOCKER_NAMESPACE}/${CI_JOB_NAME}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg KAFKA_REST_VERSION