name: mirror
on:
  # Only manual trigger
  workflow_dispatch:

jobs:
  mirror:
    name: mirror
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up SSH and mirror to remotes
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          ssh-keyscan git.nrtn.dev >> ~/.ssh/known_hosts
          eval "$(ssh-agent -s)"
          echo '${{ secrets.SSH_PRIVATE_KEY }}' | base64 -d | ssh-add -

          # Mirror to GitHub turbovillains (use --mirror for full mirror)
          git push --mirror --force git@github.com:turbovillains/infra-setup.git

          # Push to GitLab to trigger CI/CD (separate pushes to avoid hidden refs error)
          git push --all --force git@git.nrtn.dev:infra/infra-setup.git
          git push --tags --force git@git.nrtn.dev:infra/infra-setup.git

      - name: Summary
        run: |
          echo "## Mirror Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully mirrored repository to:" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub: turbovillains/infra-setup" >> $GITHUB_STEP_SUMMARY
          echo "- GitLab: git.nrtn.dev/infra/infra-setup" >> $GITHUB_STEP_SUMMARY
